---
title: "Difference-in-Difference with the Marshall Fire and Boulder, CO Vegetation"
author: "Laura Dee, laura.dee@colorado.edu"
date: "2/26/2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set( echo=TRUE, message=F, warning=F, fig.width = 10 )
```

**Learning objectives**

* What is the scope of a difference-in-difference model?
* What is the right design to apply a difference-in-difference model? 
* How should you organize your data before using a difference-in-difference model?
* What are the key coefficients of a difference-in-difference model? How do you interpret each of them? 
* What is the parallel trend assumption?
* Applying a difference-in-difference model to data in R

**Packages**

Here are the packages we will use in this lecture. If you don't remember how to install them, you can have a look at the code. 

* **stargazer** for nice regression tables
* **pander** for nice data tables 
* **dplyr** for data manipulation 
* **scales** to adjust values in simulated data 

```{r, echo = FALSE}
library(stargazer)
library(pander)
library(dplyr)
library(scales)
library(data.table)
require(fixest)

```
## Difference-in-Difference Recap
As suggested by the name, the diff-in-diff estimator is the **difference of their mean differences**. More clearly, the diff-in-diff estimator takes

* the difference in the treatment group before and after the treatment (the *treatment effect*) 

and substracts:

* the difference in the control group before and after the treatment (the *trend* over time)

as in the following formula:

\begin{equation} 
\text{(Treatment_post - Treatment_pre) - (Control_post - Control_pre) = Diff-in-Diff estimate}
  (\#eq:didtable)
\end{equation}

```{r CF, fig.cap="", echo=F }
T1 <- 50
T2 <- 85
CF <- 70
C1 <- 35
C2 <- 55

palette( c( adjustcolor( "steelblue", alpha.f=1), adjustcolor( "darkred", alpha.f=1)  ) )

plot( c(0,1,0,1), c(T1,T2,C1,C2), bty="n",
      xlim=c(-1,2), ylim=c(30,95),
      col=c("steelblue","steelblue","darkred","darkred"), pch=19, cex=6, 
      xaxt="n", yaxt="n",
      xlab="", ylab="" 
      #main = bquote("Diff-in-Diff" ~ beta[3]), cex.main = 2,
      )

segments( x0=0.08, x1=0.902, y0=C1, y1=C2, col="gray", lwd=2 )
segments( x0=0.08, x1=0.902, y0=T1, y1=T2, col="gray", lwd=2 )

text( c(0,1,0,1), c(T1,T2,C1,C2), c(T1,T2,C1,C2), cex=1.5, col="white" )

axis( side=1, at=c(0,1), 
      labels=c("Pre-intervention",
      "Post-intervention" ) )

text( 1.1, T2+7, "Treatment Group", col="Steelblue", pos=4, cex=1 )
text( 1.1, C2+7, "Comparison Group", col="darkred", pos=4, cex=1 )

text( -0.1, T1, expression(paste(beta[0] + beta[1])), col="steelblue", pos=2, cex = 2 )
text( 1.1, T2, expression(paste(beta[0] + beta[1] + beta[2] + beta[3])), col="steelblue", pos=4, cex=2 )
text( -0.1, C1, expression(paste(beta[0])), col="darkred", pos=2, cex = 2 )
text( 1.1, C2, expression(paste(beta[0] + beta[2])), col="darkred", pos=4, cex=2 )

#text( -0.1, T1-5, "= 35 + 15", col="steelblue", pos=2, cex=1)
#text( 1.7, T2-5, "= 35 + 15 + 20 + 15", col="steelblue", pos=2, cex=1)

# Counterfactual

cf.col <- "darkgreen"

points( 1, CF, cex=6, col=cf.col )
segments( x0=0.1, x1=0.9, y0=T1+1, y1=CF-1, col=cf.col, lwd=1, lty=2 )
text( 1, CF, CF, col=cf.col, cex=1.5 )
text( 1.1, CF+7, "Counterfactual", col=cf.col, pos=4, cex=1 )
text( 1.1, CF, expression(paste(beta[0] + beta[1] + beta[2])), col=cf.col, pos=4, cex=2 )
```

## The statistical model

In mathematical terms, we are interested in estimating 3 coefficients, as in the following equation: 

\begin{equation} 
\text{Y} = \beta_0 + \beta_1*Treatment + \beta_2*Post + \beta_3 * Treatment * Post + \text{e}
  (\#eq:did)
\end{equation}

Where:
<br>
<br>
$\text{Y}$ is our outcome variable;
<br>
<br>
$\text{Treatment}$ is a dummy variable indicating the treatment (=1) and control (=0) group; 
<br>
<br>
$\text{Post}$ is a dummy variable indicating pre (=0) and post (=1) treatment;
<br>
<br>
$\text{Treatment * Post}$ is a dummy variable indicating whether the outcome was observed in the treatment group AND it was observed after the intervention (=1), or any other case (=0).

It is important to note that in a diff-in-diff model:

> * We are going to look at grouped data, as we will always compare a treatment and a control group.
>
> * The coefficients will represent group means and their differences. The diff-in-diff model does not include a slope.

### Hypothesis tests happening in a diff-in-diff
Note that each of the coefficient tests a different hypothesis - it tells us something fundamentally different about the model. 

 $\beta$ | HYPOTHESES
|----- |--------------------------------------------
$b_0$ | Is the average outcome of the control group before the treatment $\ne$ 0? |
 $b_1$ | Is the difference between the control and treatment group before the treatment $\ne$ 0?  |
$b_2$ | Is the difference between the average outcome of the control group before and after the treatment $\ne$ 0?  |
 $b_3$ | Difference in difference estimator. Does the treatment have an impact? |

# A Difference-in-Difference model for evaluating effects of the Marshall Fire on plant conservation
```{r housing, fig.cap="Marshall Fire, Boulder, CO 2021", out.width='60%', echo=F }
knitr::include_graphics("FIGURE/Marshallfire.png")
```

Boulder Open Space & Mountain Parks has provided vegetation monitoring data from multiple conservation targets surrounding the Marhshall Fire. The Marshall Fire was a grassland fire in the woodland-urban interface (WUI) that led to catastrophic damages in 2021.  

We can test the hypothesis that **the fire increase bare patches and reduce live cover** using a difference-in-difference model. To do so, we are going to load the data from Brian Anacker and Ann Lezberg, which includes transects that burned (treatment group) and did not burn (control group), as well as data prior to and after the Marshall Fire. 

> **Research question**: 
> Do severe fires increase bare patches in grasslands?  Do severe fires reduce native plant cover? 
>
> **Hypothesis**: 
> Native cover decreases and bare patches increase after severe fire.

## Draw your DAG
You will investigate the causal effect of the fire on vegetation outcomes, particularly dimensions of plant cover and bare cover. First, you will draw a DAG that considers sources of selection bias and confounding variables.  

From your DAG, you can see that there are inherent differences in the locations of the monitoring transects and grassland communities that may have made some sites more likely to burn than others, including: 

* baseline differences in native cover across the plots before the fire, which could have also influenced fuel loads for burning; 
* baseline differences in non-native cover and in C3 and C4 plants, which could also influence flammability; 
* inherent differences in the transect locations that could differ in their probability of ignition or getting in the fire's path. 

## Data
```{r}
firedata <- read.csv("marshallfire_classdemo.csv")
head(firedata)
```

First, take a look at the simplified data.
The dataset contains the following variables:

 **Variable name   **   | **Description    **                                                                         | 
----------------------- | ------------------------------------------------------------------------------------------- |
$\text{Year}$    | Year of the transect survey                                                                                |
$\text{ControlImpact}$  | C=Control, I = Impact; The impacted sites burned in 2021; the control sites did not burn |
$\text{stratum}$ | The stratum represents the  Conservation Target as described in the Grassland Ecosystem Management Plan.  |
$\text{Nat_cov}$ | Sum of cover from line intercept (sum of hits) for species identified as native      |
$\text{Barecov}$ | Summed absolute value of all "bare" ground cover on transect.  Bare ground cover is including when no vegetation overlies that point and includes gravel or rocks less than 1 cm diameter and bare exposed organic or mineral soil.  |  

A note on conservation targets "stratum": The stratum represents the  Conservation Target as described in the Grassland Ecosystem Management Plan. OSMP conservation target (XTGM=xeric tall grass prairie mosaic; MBB=Mesic Big Bluestem; MGPM=Mixed grass prairie mosiac). The original random sample of 160 transects was stratified by stratum, using a GRTS design to create a spatially-balanced random set within each stratum and within the grassland system as a whole.  The fire did not burn an equal number of transects in each strata, but there was representation in each.

We will first create a dummy variable for whether the transect was burned (treated) or not (control group). 
```{r,}
firedata$treat <- ifelse(firedata$ControlImpact == "Impact", "1" , "0")
# table(firedata$treat)
```

See this useful function to create dummy variables fast and easy: [dummy_cols](https://cran.r-project.org/web/packages/fastDummies/vignettes/making-dummy-variables.html)
```{r, echo=F}
firedata$treatmentDemo <- fastDummies::dummy_cols(firedata, select_columns = "ControlImpact")
```

We will then create a dummy variable indicating whether the sample was taken before or after the fire in 2021. 
```{r}
# firedata$BeforeAfter <- ifelse(firedata$Year>2021, "after", "before")
firedata$Post_Treatment  <- ifelse(firedata$Year>2021, "1" , "0")
```

## Analysis
Our model is based on the equation \@ref(eq:did):

<center>$\text{Y} = \beta_0 + \beta_1*Group + \beta_2*Treatment + \beta_3 * Group * Treatment + \text{e}$</center>

```{r, results='asis'}
#Run a regression with bare cover as the outcome 
regbare <- lm(Barecov ~ treat + Post_Treatment+ treat:Post_Treatment, data = firedata)
#summary(regbare)
stargazer(regbare,
           type = "html",
           dep.var.labels = ("Bare Patches"),
           column.labels = c(""),
           covariate.labels = c("Intercept (B0)",
                                "Treatment group (B1)",
                                "Post-treatment (B2)",
                                "Diff in Diff (B3)"),
           omit.stat = "all",
           digits = 0,
           intercept.bottom = FALSE)
```

### Recall:

* $\beta_1$ represents the difference between the treatment and the control group before the treatment. In the regression with Bare Patches (Barecov as the outcome), $\beta_1$ is be equal to -1.6, such that $\beta_0$ + $\beta_1$ = 1.8, the average outcome of the treatment group before the treatment. 

* $\beta_2$ represents how much the average outcome of the control group has changed in the post-treatment period. The average outcome of the control group in the post-treatment period will be equal to the initial (pre-treatment) mean - $\beta_0$ plus $\beta_2$. 

* Note that $beta_2$ represent the trend over time, or the gains that occur over time *independent from the treatment*.

* Finally, $\beta_3$ is the key parameter that we are interested in estimating. It represents how much the average outcome of the treatment group has changed in the period after the treatment, compared to what it would happened to the same group had the intervention not occurred. If $beta_3$ = 0, we can conclude that the treatment had no effect.

* Note that $\beta_3$ represents the difference; to calculate the average outcome of the treatment group after the treatment, we need to add the initial average outcome ($beta_0$ + $beta_1$), the gains over time independent from the treatment ($beta_2$) and the gains because of the treatment ($beta_3$).  

### What about for native cover? Which hypothesis is supported?
```{r, results='asis'}
reg <- lm(Nat_cov ~ treat + Post_Treatment + treat:Post_Treatment, data = firedata)
#summary(reg)
stargazer(reg,
           type = "html",
           dep.var.labels = ("Nat_cov"),
           column.labels = c(""),
           covariate.labels = c("Intercept (B0)",
                                "Treatment group (B1)",
                                "Post-treatment (B2)",
                                "Diff in Diff (B3)"),
           omit.stat = "all",
           digits = 0,
           intercept.bottom = FALSE)
```


## Discussion of Results
As we discussed in our section \@ref(The-statistical-model) each coefficient tests a different hypothesis. By looking at the results we should be able to answer the following questions: 

1. Is the comparison group in Time = 1 different from zero?
2. Did the treatment and comparison groups differ significantly in the first time period? In other words, do transects that burned have higher native cover than transects that did not burn? 
3. Did the comparison group change significantly between the first and second time periods? In other words, does the native cover of transects in the control group increase over time?
4. Is the treatment group in Time = 2 different from the counterfactual? In other words, did the fire change the native cover of burned transects  If our hypothesis is supported for native cover, we would expect a negative and significant coefficient, or a positive and significant coefficient for bare ground!


### Answers: you do answer them!


## What about for different outcomes (response variables)?

In the data, you'll notice several other columns for different indicators of plant health in the GMAP plan. Choose a different outcome variable to look at and run a difference-in-difference regression. Interpret the outcomes and be ready to present and discuss your results.


 **Variable name   **   | **Description    **                                                                         | 
----------------------- | ------------------------------------------------------------------------------------------- |
$\text{Rel_PerGraCov}$ | Relative perennial graminoid cover calculated as perennial graminoid cover over total vegetative cover x 100.  |  $\text{Cov_C4}$    |     Sum of cover from line intercept (sum of hits) for species identified as C4 photosynthetic pathway.  |
$\text{NonNat_cov}$  | Sum of cover from line intercept (sum of hits) for all plant species or taxon identified as non-native. |
$\text{AllSp_cnt}$ | Count of all unique species codes or taxon codes identified on the 2 x 50 m transect including native species, nonnative species and those not identified to the species level |
$\text{PerGram_Cov}$ | Sum of cover from line intercept (sum of hits) for species identified as perennial graminoids (grasslike) species.  This indicator is derived from life history and life form classifications for each species found in the monitoring species table.  For the purpose of our indicators, "graminoid" includes species in the  Poaceae, Cyperaceae, Juncaceae, and Juncaginaceae families and Unknown graminoid species.  |
$\text{Cov_Forb}$ | Sum of cover from line intercept (sum of hits) for all species identified as forbs.   |  
$\text{BiAnn_Cov}$ | Sum of cover from line intercept (sum of hits) for all species identified as Annual, Annual/Biennial, or Biennial  |  

### Create a hypothesis 
Fill in the blank:

### Run your regression and interpret the outcome
You do this part yourself in the R console! 


## Questions from OSMP 
Brian Anacker and Ann Lezberg also prepared a list of questions for someone to consider when analyzing the data:  

1. What is the appropriate statistical model/approach to use, given the experimental design, and how do we check the assumptions of the statistical test(s)?
2. What problems with the data or design do we need to address with our choice of analyses and interpretation (or with transformations)?
3. Which of the indicators show a statistically significant effect owing to the unique effect of fire?
4. Are there any interactions with the three different grassland types (labelled “Stratum” in the variable header but also referred to as conservation target)?
5. Given the results, what do you think is going to happen to the grasslands as they recover from fire, and would you prescribe any management interventions?
6. What other data could we collect to address our questions?
7. Bonus: is there spatial autocorrelation in our data, does it matter, and how should we deal with it? What is spatial autocorrelation?




<!-- ```{r beta0, fig.cap="Difference in difference, beta 0", echo=F } -->
<!-- T1 <- 50 -->
<!-- T2 <- 85 -->
<!-- CF <- 75 -->
<!-- C1 <- 35 -->
<!-- C2 <- 55 -->

<!-- palette( c( adjustcolor( "steelblue", alpha.f=1), adjustcolor( "darkred", alpha.f=1)  ) ) -->

<!-- plot( c(0,1,0,1), c(T1,T2,C1,C2), bty="n", -->
<!--       xlim=c(-1,2), ylim=c(30,95), -->
<!--       col=c("gray","gray","darkred","gray"), pch=19, cex=6,  -->
<!--       xaxt="n", yaxt="n", -->
<!--       xlab="", ylab="" -->
<!--       #main = bquote("Diff-in-Diff" ~ beta[0]), cex.main = 2, -->
<!--       ) -->

<!-- segments( x0=0.08, x1=1, y0=C1, y1=C2, col="gray", lwd=2 ) -->
<!-- segments( x0=0, x1=1, y0=T1, y1=T2, col="gray", lwd=2 ) -->

<!-- text( c(0,1,0,1), c(T1,T2,C1,C2), c(T1,T2,C1,C2), cex=1.5, col="white" ) -->

<!-- axis( side=1, at=c(0,1),  -->
<!--       labels=c("Pre-intervention", -->
<!--       "Post-intervention" ) ) -->

<!-- text( 1.1, T2-5, "Treatment Group", col="gray54", pos=4, cex=1 ) -->
<!-- text( 1.1, C2-5, "Control Group", col="darkred", pos=4, cex=1 ) -->
<!-- text( -0.1, C1, expression(paste(beta[0])), col="darkred", pos=2, cex=2 ) -->
<!-- text( -0.1, C1-5, "= 35", col="darkred", pos=2, cex=1 ) -->

<!-- text(-1, 95, expression(paste(beta[0], "=35")), col = "black", cex = 1.5) -->
<!-- text(-1, 88, expression(paste(beta[1], "=15")), col = "gray54", cex = 1.5) -->
<!-- text(-1, 81, expression(paste(beta[2], "=20")), col = "gray54", cex = 1.5) -->
<!-- text(-1, 74, expression(paste(beta[3], "=15")), col = "gray54", cex = 1.5) -->
<!-- ``` -->



